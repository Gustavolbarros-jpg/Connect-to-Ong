name: CI - Test and Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      # === DEPENDÃŠNCIAS ===
      - name: ðŸ“¦ Install Root Dependencies
        run: npm ci

      - name: ðŸ“¦ Install Backend Dependencies
        run: npm ci --prefix backend

      - name: ðŸ“¦ Install Frontend Dependencies
        run: npm ci --prefix frontend

      # === VALIDAÃ‡ÃƒO E TESTES ===
      - name: ðŸ”Ž Validate Prisma Schema
        # CORREÃ‡ÃƒO: Executa o prisma a partir do workspace do backend
        run: npm exec --prefix backend -- prisma validate --schema=./backend/prisma/schema.prisma
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: ðŸ§ª Run Backend Tests (Jest)
        # NOVO: Adiciona a etapa de teste do backend
        run: npm run test:back
        env:
          # Adicione as variÃ¡veis de ambiente que seus testes precisam
          DATABASE_URL: ${{ secrets.DATABASE_URL_TEST }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: ðŸ§ª Run Frontend Tests (Jest/Vitest)
        # NOVO: Adiciona a etapa de teste do frontend
        run: npm run test:front

      # === BUILD ===
      - name: ðŸ—ï¸ Build Frontend Application
        run: npm run build --prefix frontend
        env:
          # Exemplo de variÃ¡vel de ambiente para o build
          VITE_BASE_URL: /

      # === DOCKER BUILD ===
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Backend Docker Image
        run: docker build --file backend/Dockerfile -t connect-ong-backend:ci .

      - name: ðŸ³ Build Frontend Docker Image
        run: docker build --file frontend/Dockerfile -t connect-ong-frontend:ci .

      # === VALIDAÃ‡ÃƒO DO DOCKER COMPOSE ===
      - name: ðŸ“ Create .env file for Compose
        # CORREÃ‡ÃƒO: Cria o arquivo .env, nÃ£o .env.backend
        run: |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}" >> .env
          echo "AUTH_EMAIL=${{ secrets.AUTH_EMAIL }}" >> .env
          echo "AUTH_PASS=${{ secrets.AUTH_PASS }}" >> .env
          echo "NODE_ENV=production" >> .env
          echo "PORT=3007" >> .env
          echo "APP_URL=http://localhost:8087" >> .env

      - name: ðŸ§© Validate Docker Compose Configuration
        run: docker compose -f docker-compose.yml config

      - name: ðŸŽ‰ Success notification
        run: echo "ðŸŽ‰ CI Pipeline finished successfully!"